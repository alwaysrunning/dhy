/**
 * Created by ricopter@qq.com on 2016/11/29.
 *
 *

//获取付款码：
 http://o2o.52bill.com/online-offline/OSTPUSR1/USR20017.tran?SIEBEL_ID=XXXX
 //我的资产页面
 http://o2o.52bill.com/online-offline/OSTPUSR1/USR20011.tran?SIEBEL_ID=XXXX

 //修改支付密码
 http://o2o.52bill.com/online-offline/OSTPUSR1/USR10007.tran?SIEBEL_ID=XXXX
 //忘记支付密码
 http://o2o.52bill.com/online-offline/OSTPUSR1/USR10018.tran?SIEBEL_ID=XXXX
 //设置安全问题
 http://o2o.52bill.com/online-offline/OSTPUSR1/USR10009.tran?SIEBEL_ID=XXXX

 * 支付URL签名
 */
'use strict';
var config = require('../conf');
var crypto = require("crypto");
var Buffer = require("buffer").Buffer;
var request = require('./request');

//md5加密
var md5 = function (input) {
    return crypto.createHash("md5").update(input, 'utf8').digest("hex");
};

/**
 * 获取加密后的 SiebelId
 * @param operationType 0加密 1解密
 * @param tokenOrUnionid
 * @returns {*}
 */
var getSiebelCode=function (tokenOrUnionid,operationType) {
    return request.getTokens(tokenOrUnionid).then(function (tokens) {
        return request.getAuth({
            method: 'bubugao.mobile.bbgpay.member.encrypt',
            operationType: operationType
        }, tokens);
    });
};

/**
 * url支付签名方法
 * @param siebelIdCode
 * @returns {string}
 */
var signParam = function (siebelIdCode) {
    var key="F7C711C09555793F138D6C06210E16E9";
    var timeLater=15*60*1000;
    var nowTimes=new Date().getTime();
    var TM_SMP=nowTimes+timeLater;
    var signStr="SIEBEL_ID="+siebelIdCode+"&TM_SMP="+TM_SMP+"&key="+key;
    //console.log(signStr);
    var sign=md5(signStr).toUpperCase();
    return "SIEBEL_ID="+siebelIdCode+"&TM_SMP="+nowTimes+"&sign="+sign;
};

/**
 *  获取支付URL签名参数
 * @param tokenOrUnionid
 * @returns {*}
 */

module.exports.getUrlSignParam=function (tokenOrUnionid) {
     return getSiebelCode(tokenOrUnionid,"0").then(function (siebelIdCode) {
        return signParam(siebelIdCode.data)
     })
};
