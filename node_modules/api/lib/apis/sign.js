/**
 * Created by 沐沐 on 2015-07-16.
 * app接口效验加密模块
 */
var config = require('../conf');
var crypto = require("crypto");
var Buffer = require("buffer").Buffer;

//md5加密
var md5 = function (input) {
    return crypto.createHash("md5").update(input, 'utf8').digest("hex");

    //var hash = crypto.createHash('md5');
    //return hash.update(input).digest('hex');
};

//将请求参数连成字符串(顺便按照字母顺序排序)
var paramsString = function (params) {
    return Object.keys(params).sort().map(function (key) {
        if (params[key]) {
            return key + params[key];
        } else {
            return '';
        }
    }).join('');
};

module.exports = function (params, secret, timestamp) {
    var string = paramsString(params);
    var sign = md5(secret + timestamp + md5(string) + secret);
    if (config().api.printSign) {
        console.log('==============================================================');
        console.log('参数拼接：' + string);
        console.log('签名信息：sign(' + sign + '),timestamp(' + timestamp + '),secret(' + secret + ')');
    }
    return sign;
};

